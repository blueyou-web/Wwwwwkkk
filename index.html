<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>인터랙티브 텍스트 어드벤처 게임</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #0c0d14; /* 어두운 우주 색 */
            background-image: radial-gradient(circle at top right, rgba(47, 71, 150, 0.3), transparent 40%),
                              radial-gradient(circle at bottom left, rgba(47, 71, 150, 0.3), transparent 40%);
        }

        #root-container {
            width: 100%;
            max-width: min(90vw, 2560px); 
            aspect-ratio: 21 / 9;
            max-height: 95vh;
        }

        #dialogue-container-wrapper {
            position: absolute; bottom: 0; left: 0; right: 0; display: flex; justify-content: center; padding: 2rem; pointer-events: none;
        }
        
        #dialogue-layout-container { pointer-events: auto; }

        .dialogue-box {
            background-image: linear-gradient(to bottom, rgba(12, 13, 20, 0.95), rgba(12, 13, 20, 0.75));
            backdrop-filter: blur(8px); 
            border: none;
            border-radius: 2rem; 
            padding-left: 2rem; 
            padding-right: 2rem;
        }

        #dialogue-text { white-space: pre-wrap; }

        #character-name { color: #a7b5e8; font-weight: 700; text-shadow: 0 0 5px #2f4796; }

        .choice-btn {
            background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.6));
            border: 1px solid transparent;
            border-radius: 9999px;
            color: #e2e8f0;
            text-align: center;
            padding: 0.5rem 1rem;
            transition: all 0.2s;
        }

        .choice-btn:hover {
            background-image: linear-gradient(to bottom, rgba(20, 20, 20, 0.9), rgba(20, 20, 20, 0.7));
            color: white;
            box-shadow: 0 0 10px #2f4796;
            border-color: white;
        }
        
        @keyframes pulse-hotspot {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }
        .hotspot {
            position: absolute;
            background-color: transparent; border: 2px solid white; 
            border-radius: 50%;
            transition: background-color 0.2s, border-color 0.2s; 
            animation: pulse-hotspot 2s infinite;
            aspect-ratio: 1 / 1;
            display: flex;
            justify-content: center;
            align-items: center;
            filter: drop-shadow(0 1px 5px rgba(0, 0, 0, 0.6));
        }
        .hotspot:hover { background-color: rgba(255, 255, 255, 0.2); border-color: rgba(255, 255, 255, 1); animation: none; }

        .hotspot-label-container {
            position: absolute;
            left: 90%;
            top: 10%;
            width: 150px;
            height: 100px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .hotspot:hover .hotspot-label-container {
            opacity: 1;
        }

        .hotspot-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .hotspot-line polyline {
            fill: none;
            stroke: white;
            stroke-width: 1.5;
            stroke-dasharray: 100;
            stroke-dashoffset: 100;
            transition: stroke-dashoffset 0.4s ease-out;
        }

        .hotspot:hover .hotspot-line polyline {
            stroke-dashoffset: 0;
        }
        
        .hotspot-name {
            position: absolute;
            left: 55px; 
            top: -22px; 
            color: white;
            background-color: rgba(0,0,0,0.6);
            padding: 4px 10px;
            border-radius: 4px;
            text-shadow: 0 0 5px black;
            font-size: 1rem; 
            font-weight: bold;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease 0.2s, transform 0.3s ease 0.2s;
            white-space: nowrap;
        }

        .hotspot:hover .hotspot-name {
            opacity: 1;
            transform: translateY(0);
        }

        #admin-panel, .modal-content-bg { background-color: #1a1c2c; }
        #admin-panel h2, #syntax-modal h3, #lobby-screen h1 { color: #a7b5e8; }

        #lobby-screen-wrapper {
             background-color: transparent;
        }

        .story-item {
            background-color: rgba(0,0,0,0.4);
            border: 1px solid rgba(167, 181, 232, 0.2);
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .story-item:hover {
            background-color: rgba(47, 71, 150, 0.3);
            border-color: rgba(167, 181, 232, 0.8);
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(167, 181, 232, 0.3);
        }
        .story-item-title { font-size: 1.125rem; font-weight: bold; color: #e2e8f0; }
        .story-item-meta { font-size: 0.8rem; color: #a7b5e8; }
        
        #create-new-story-btn { 
            background-image: linear-gradient(to right, #2f4796, #4e68b3);
            border: none;
        }
        .modal-button { background-color: #2f4796; }
        .modal-button-secondary { background-color: #4a5568; }

        .control-btn {
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .control-btn:hover {
            background-color: rgba(0,0,0,0.7);
            border-color: white;
        }

        #admin-panel, #syntax-modal-content, #story-list-container { scrollbar-width: thin; scrollbar-color: #4a5568 #1a1c2c; }
        .hotspot-preview { 
            position: absolute; box-sizing: border-box; cursor: move; border: 2px solid transparent; background-color: rgba(47, 71, 150, 0.2);
            border-radius: 50%; 
            aspect-ratio: 1 / 1;
        }
        .hotspot-preview.selected { border: 2px solid #a7b5e8; background-color: rgba(47, 71, 150, 0.4); }
        .resize-handle { position: absolute; width: 10px; height: 10px; background-color: #a7b5e8; border: 1px solid #fff; opacity: 0; transition: opacity 0.2s; }
        .hotspot-preview.selected .resize-handle { opacity: 1; }
        .resize-handle.br { bottom: -5px; right: -5px; cursor: se-resize; }
        #scene-script-editor { white-space: pre-wrap; word-wrap: break-word; }
        #syntax-modal pre { white-space: pre-wrap; word-break: break-all; }

        #location-popup {
            transition: opacity 0.5s ease-in-out;
        }
        #location-popup-content {
            background-color: #0c0d14;
            padding: 1.5rem 4rem;
            border-top: 2px solid #a7b5e8;
            border-bottom: 2px solid #a7b5e8;
            box-shadow: 0 0 20px rgba(47, 71, 150, 0.5);
        }

        #event-popup {
            transition: opacity 0.5s ease-in-out;
        }
        #event-popup-content {
            background: transparent;
            border: none;
            box-shadow: none;
            padding: 0;
            display: flex;
            gap: 0.1em;
        }
        .event-char {
            display: inline-block;
            opacity: 0;
            transform: translateY(25px) scale(0.7);
            transition: opacity 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-shadow: 0 0 15px rgba(59, 130, 246, 0.8), 0 0 5px rgba(147, 197, 253, 1);
            color: #dbeafe;
        }
        .event-char.visible {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        
        #exit-hotspot-btn {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 35;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 9999px;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        #exit-hotspot-btn:hover {
            background-color: rgba(255, 255, 255, 1);
            color: black;
            transform: scale(1.1) rotate(90deg);
            border-color: transparent;
        }

        .restart-option-btn {
            background-color: rgba(26, 28, 44, 0.9);
            color: #e2e8f0;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            font-weight: bold;
            white-space: nowrap;
            transition: all 0.2s ease;
            border: 1px solid rgba(167, 181, 232, 0.2);
        }
        .restart-option-btn:hover {
            background-color: rgba(47, 71, 150, 0.8);
            color: white;
            border-color: rgba(167, 181, 232, 0.8);
        }

        #save-slots-container {
            transition: opacity 0.3s ease-in-out;
        }
        .save-slot {
            position: relative;
            width: 150px;
            height: 50px;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 0.5rem;
            color: rgba(255,255,255,0.5);
            font-size: 0.8rem;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px;
        }
        .save-slot.filled {
            color: white;
            border-color: rgba(167, 181, 232, 0.8);
        }
        .save-slot:hover {
            background-color: rgba(47, 71, 150, 0.7);
            border-color: white;
        }
        .save-slot-title {
            font-weight: bold;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 90%;
            text-align: center;
        }
        .save-slot-time {
            font-size: 0.7rem;
            opacity: 0.7;
        }
        .delete-save-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background-color: #ef4444;
            color: white;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            opacity: 0.7;
            transition: all 0.2s ease;
        }
        .delete-save-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen overflow-hidden flex items-center justify-center">

    <div id="root-container" class="relative">
        <div id="lobby-screen" class="w-full h-full absolute inset-0">
             <div id="lobby-screen-wrapper" class="w-full h-full flex items-center justify-center rounded-lg">
                <div id="lobby-content" class="grid grid-cols-1 md:grid-cols-[auto_1fr] gap-8 w-full max-w-4xl h-4/5">
                    <div id="lobby-decoration" class="hidden md:flex items-center justify-center">
                         <svg width="100" height="200" viewBox="0 0 100 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M50 0 V200" stroke="#a7b5e8" stroke-width="2"/>
                            <circle cx="50" cy="100" r="40" stroke="#a7b5e8" stroke-width="2" fill="none"/>
                            <circle cx="50" cy="100" r="10" stroke="#a7b5e8" stroke-width="2" fill="#1a1c2c"/>
                            <g transform="translate(50 100)">
                                <path d="M0 -30 L-5 -25 L5 -25 Z" fill="#a7b5e8"/>
                                <path d="M0 30 L-5 25 L5 25 Z" fill="#a7b5e8"/>
                            </g>
                        </svg>
                    </div>
                    <div id="lobby-main" class="flex flex-col p-4 md:p-0">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-4xl font-bold text-white">챕터 선택</h1>
                            <button id="lobby-admin-toggle-btn" class="control-btn text-white p-2 rounded-full shadow-lg transition-all hover:scale-110">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                            </button>
                        </div>
                        <div id="story-list-container" class="flex-grow overflow-y-auto pr-4">
                            <div id="story-list" class="space-y-4"></div>
                        </div>
                        <button id="create-new-story-btn" class="w-full hover:opacity-80 p-3 mt-6 rounded-md font-bold transition-colors text-lg hidden">새 스토리 만들기</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="app" class="w-full h-full absolute inset-0 bg-transparent overflow-hidden hidden">
            <div id="game-container" class="w-full h-full relative">
                <div id="game-screen" class="w-full h-full bg-cover bg-center transition-all duration-500"></div>
                <div id="hotspot-previews-container"></div>
                
                <button id="exit-hotspot-btn" title="조사 종료" class="hidden">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>

                <div id="dialogue-container-wrapper" class="absolute bottom-0 left-0 right-0 p-8 pointer-events-none flex justify-center items-end">
                    <div id="dialogue-layout-container" class="w-full max-w-2xl mx-auto relative pointer-events-auto">
                        <div id="choices-box" class="absolute right-0 bottom-full mb-2 flex flex-col gap-2" style="width: 30%;"></div>
                        <div id="dialogue-content-box" class="dialogue-box py-4 w-full">
                            <p id="character-name" class="font-bold text-xl mb-2 px-10"></p>
                            <p id="dialogue-text" class="text-lg px-10"></p>
                        </div>
                    </div>
                </div>

                <div id="loading-spinner" class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                    <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-white"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="admin-panel" class="fixed top-0 bottom-0 left-0 z-50 w-full md:w-96 bg-gray-800 p-4 overflow-y-auto border-r-2 border-gray-700 transform -translate-x-full transition-transform duration-300 ease-in-out">
        <h2 class="text-2xl font-bold mb-4">어드벤처 제작 도구</h2>
        <div class="space-y-4">
            <div>
                <label for="story-title" class="block text-sm font-medium">스토리 제목:</label>
                <input type="text" id="story-title" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1">
            </div>
            <div>
                <label for="story-subtitle" class="block text-sm font-medium">스토리 부제목:</label>
                <input type="text" id="story-subtitle" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1">
            </div>
            <div>
                <label for="scene-id" class="block text-sm font-medium">현재 장면 ID:</label>
                <select id="scene-id" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1"></select>
            </div>
            <div>
                <button id="add-scene-btn" class="w-full bg-green-600 hover:bg-green-700 p-2 rounded-md transition-colors">새 장면 추가</button>
            </div>
            <div>
                <label for="bg-image" class="block text-sm font-medium">배경 이미지 URL:</label>
                <input type="text" id="bg-image" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mt-1" placeholder="https://placehold.co/800x600/...">
            </div>
            <div class="bg-gray-900 p-3 rounded-lg">
                <div class="flex justify-between items-center mb-2">
                     <h3 class="font-bold text-lg">장면 스크립트</h3>
                     <button id="syntax-help-btn" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">문법 도움말</button>
                </div>
                <textarea id="scene-script-editor" class="w-full bg-gray-700 p-2 rounded h-64 text-sm leading-relaxed" placeholder="이곳에 장면의 스토리를 작성하세요..."></textarea>
                <div class="grid grid-cols-2 gap-2 mt-2">
                    <button id="insert-dialogue-btn" class="bg-cyan-600 hover:bg-cyan-700 p-2 rounded-md text-sm">인물</button>
                    <button id="insert-choice-btn" class="bg-purple-600 hover:bg-purple-700 p-2 rounded-md text-sm">선택지</button>
                    <button id="insert-hotspot-btn" class="bg-orange-600 hover:bg-orange-700 p-2 rounded-md text-sm">조사</button>
                    <button id="insert-location-btn" class="bg-teal-600 hover:bg-teal-700 p-2 rounded-md text-sm">장소</button>
                    <button id="insert-event-btn" class="bg-pink-600 hover:bg-pink-700 p-2 rounded-md text-sm">이벤트</button>
                    <button id="insert-label-btn" class="bg-indigo-600 hover:bg-indigo-700 p-2 rounded-md text-sm">레이블</button>
                    <button id="insert-goto-btn" class="bg-yellow-600 hover:bg-yellow-700 p-2 rounded-md text-sm col-span-2">강제 이동</button>
                </div>
            </div>
            <div>
                <button id="save-story-btn" class="w-full modal-button hover:bg-blue-700 p-2 rounded-md font-bold transition-colors">스토리 저장하기</button>
            </div>
            <div>
                <button id="delete-scene-btn" class="w-full bg-red-600 hover:bg-red-700 p-2 rounded-md transition-colors">현재 장면 삭제</button>
            </div>
        </div>
    </div>
    
    <button id="admin-panel-toggle" class="fixed top-1/2 -translate-y-1/2 left-0 z-50 bg-gray-800 p-2 rounded-r-lg transition-transform duration-300 ease-in-out opacity-70 hover:opacity-100 hidden">
        <svg id="admin-toggle-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
    </button>
    
    <div id="location-popup" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center text-white text-3xl font-bold z-50 hidden opacity-0">
        <div id="location-popup-content"></div>
    </div>
    <div id="event-popup" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center text-white text-3xl font-bold z-50 hidden opacity-0">
        <div id="event-popup-content"></div>
    </div>
    
    <div id="save-slots-container" class="fixed bottom-4 left-4 flex gap-2 z-40 opacity-0 hidden">
        <button id="save-slot-1" data-slot="1" class="save-slot"></button>
        <button id="save-slot-2" data-slot="2" class="save-slot"></button>
        <button id="save-slot-3" data-slot="3" class="save-slot"></button>
    </div>
    
    <div class="fixed bottom-4 right-4 flex items-center gap-2 z-40">
        <button id="back-to-lobby-btn" class="control-btn text-white p-3 rounded-full shadow-lg transition-all hover:scale-110 hidden">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
        </button>
        
        <div id="restart-btn-container" class="relative hidden">
            <button id="restart-game-btn" class="control-btn text-white p-3 rounded-full shadow-lg transition-all hover:scale-110">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/><path d="M21 22v-6h-6"/><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"/></svg>
            </button>
            <div id="restart-options" class="absolute bottom-full mb-2 right-0 p-2 rounded-lg bg-gray-900 bg-opacity-80 backdrop-blur-sm hidden flex-col items-end gap-2 transition-all duration-300">
                <button id="restart-scene-btn" class="restart-option-btn">이 장면부터</button>
                <button id="restart-story-btn" class="restart-option-btn">처음부터</button>
            </div>
        </div>

        <button id="toggle-admin-btn" class="control-btn text-white p-3 rounded-full shadow-lg transition-all hover:scale-110 hidden">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
        </button>
    </div>
    
    <!-- Modals (unchanged) -->
    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50"><div class="modal-content-bg rounded-lg p-6 shadow-xl max-w-sm text-center"><p id="message-text" class="mb-4 text-lg"></p><button id="message-ok-btn" class="modal-button hover:opacity-80 px-6 py-2 rounded-md">확인</button></div></div>
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50"><div class="modal-content-bg rounded-lg p-6 shadow-xl max-w-sm text-center"><p id="confirm-text" class="mb-4 text-lg"></p><div class="flex justify-center space-x-4"><button id="confirm-yes-btn" class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded-md">예</button><button id="confirm-no-btn" class="modal-button-secondary hover:opacity-80 px-6 py-2 rounded-md">아니오</button></div></div></div>
    <div id="input-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50"><div class="modal-content-bg rounded-lg p-6 shadow-xl w-full max-w-sm"><p id="input-text" class="mb-4 text-lg text-center"></p><input type="text" id="input-field" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 mb-4"><div class="flex justify-center space-x-4"><button id="input-ok-btn" class="modal-button hover:opacity-80 px-6 py-2 rounded-md">확인</button><button id="input-cancel-btn" class="modal-button-secondary hover:opacity-80 px-6 py-2 rounded-md">취소</button></div></div></div>
    <div id="syntax-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4"><div id="syntax-modal-content" class="bg-gray-800 rounded-lg p-6 shadow-xl w-full max-w-2xl text-left relative max-h-full overflow-y-auto"><h3 class="text-2xl font-bold mb-4 border-b border-gray-700 pb-2">스크립트 문법 도움말</h3><button id="syntax-close-btn" class="absolute top-6 right-6 text-gray-400 hover:text-white text-3xl leading-none">&times;</button><div class="space-y-6 text-gray-300 mt-4"><div><h4 class="font-bold text-lg text-teal-400">장소 / 이벤트</h4><p class="text-sm mt-1">장면 시작 시 장소 이름이나 이벤트 텍스트를 팝업으로 표시합니다.</p><pre class="bg-gray-900 p-3 rounded mt-2 text-sm text-white"><code>[장소: 장소 이름]\n[EVENT: 이벤트 발생!]</code></pre></div>
    <div><h4 class="font-bold text-lg text-yellow-400">강제 이동</h4><p class="text-sm mt-1">해당 라인을 읽는 즉시 다른 장면으로 강제 이동시킵니다.</p><pre class="bg-gray-900 p-3 rounded mt-2 text-sm text-white"><code>[GOTO: 이동할_장면ID]</code></pre></div>
    <div><h4 class="font-bold text-lg text-indigo-400">레이블</h4><p class="text-sm mt-1">스크립트 내 특정 위치로 점프할 수 있는 책갈피를 만듭니다.</p><pre class="bg-gray-900 p-3 rounded mt-2 text-sm text-white"><code>[LABEL: 레이블_이름]\n...\n> 선택지 {GOTO: 장면ID@레이블_이름}</code></pre></div><div><h4 class="font-bold text-lg text-cyan-400">인물 및 대사</h4><p class="text-sm mt-1">화자를 지정하고 대사를 출력합니다.</p><pre class="bg-gray-900 p-3 rounded mt-2 text-sm text-white"><code>[인물: 캐릭터 이름]\n대사 내용입니다.</code></pre></div><div><h4 class="font-bold text-lg text-purple-400">선택지</h4><p class="text-sm mt-1">플레이어에게 선택지를 제공합니다.</p><pre class="bg-gray-900 p-3 rounded mt-2 text-sm text-white"><code>[선택지]\n> 선택지 1 {GOTO: 장면ID}\n> 선택지 2 {SHOW: 텍스트1 / 텍스트2}</code></pre></div><div><h4 class="font-bold text-lg text-orange-400">조사 지점 (핫스팟)</h4><p class="text-sm mt-1">화면에 클릭 가능한 영역을 만듭니다.</p><pre class="bg-gray-900 p-3 rounded mt-2 text-sm text-white"><code>[조사지점]\n@ 이름 {X:10, Y:10, W:20, H:20, SHOW: 텍스트1 / 텍스트2}</code></pre></div></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, getDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const startApp = async () => {
            // --- CONFIGURATION ---
            const firebaseConfig = {
                apiKey: "AIzaSyDHBS2i2uJDILdx0Cu2fASU2F0m2Xjfkus",
                authDomain: "qwqweqwe-17b83.firebaseapp.com",
                projectId: "qwqweqwe-17b83",
                storageBucket: "qwqweqwe-17b83.appspot.com",
                messagingSenderId: "687682911187",
                appId: "1:687682911187:web:04417dcdca24d889d30d26"
            };

            // --- DOM ELEMENTS ---
            const lobbyScreen = document.getElementById('lobby-screen');
            const storyList = document.getElementById('story-list');
            const createNewStoryBtn = document.getElementById('create-new-story-btn');
            const appContainer = document.getElementById('app');
            const gameContainer = document.getElementById('game-container');
            const gameScreen = document.getElementById('game-screen');
            const hotspotPreviewsContainer = document.getElementById('hotspot-previews-container');
            const characterName = document.getElementById('character-name');
            const dialogueText = document.getElementById('dialogue-text');
            const choicesBox = document.getElementById('choices-box');
            const dialogueContentBox = document.getElementById('dialogue-content-box'); 
            const adminPanel = document.getElementById('admin-panel');
            const storyTitleInput = document.getElementById('story-title');
            const storySubtitleInput = document.getElementById('story-subtitle');
            const toggleAdminBtn = document.getElementById('toggle-admin-btn');
            const adminPanelToggle = document.getElementById('admin-panel-toggle');
            const adminToggleIcon = document.getElementById('admin-toggle-icon');
            const backToLobbyBtn = document.getElementById('back-to-lobby-btn');
            const loadingSpinner = document.getElementById('loading-spinner');
            const locationPopup = document.getElementById('location-popup');
            const locationPopupContent = document.getElementById('location-popup-content');
            const eventPopup = document.getElementById('event-popup');
            const eventPopupContent = document.getElementById('event-popup-content');
            const sceneIdSelect = document.getElementById('scene-id');
            const bgImageInput = document.getElementById('bg-image');
            const addSceneBtn = document.getElementById('add-scene-btn');
            const deleteSceneBtn = document.getElementById('delete-scene-btn');
            const saveStoryBtn = document.getElementById('save-story-btn');
            const sceneScriptEditor = document.getElementById('scene-script-editor');
            const syntaxHelpBtn = document.getElementById('syntax-help-btn');
            const syntaxModal = document.getElementById('syntax-modal');
            const syntaxCloseBtn = document.getElementById('syntax-close-btn');
            const insertDialogueBtn = document.getElementById('insert-dialogue-btn');
            const insertChoiceBtn = document.getElementById('insert-choice-btn');
            const insertHotspotBtn = document.getElementById('insert-hotspot-btn');
            const insertLocationBtn = document.getElementById('insert-location-btn');
            const insertLabelBtn = document.getElementById('insert-label-btn');
            const insertEventBtn = document.getElementById('insert-event-btn');
            const exitHotspotBtn = document.getElementById('exit-hotspot-btn');
            const restartBtnContainer = document.getElementById('restart-btn-container');
            const restartGameBtn = document.getElementById('restart-game-btn');
            const restartOptions = document.getElementById('restart-options');
            const restartSceneBtn = document.getElementById('restart-scene-btn');
            const restartStoryBtn = document.getElementById('restart-story-btn');
            const insertGotoBtn = document.getElementById('insert-goto-btn');
            const lobbyAdminToggleBtn = document.getElementById('lobby-admin-toggle-btn');
            const saveSlotsContainer = document.getElementById('save-slots-container');

            // --- UTILITIES (Modals) ---
            const { showMessage, showConfirm, showInput } = (function setupModals() { /* ... (unchanged) ... */ const messageModal = document.getElementById('message-modal'); const messageText = document.getElementById('message-text'); const messageOkBtn = document.getElementById('message-ok-btn'); const confirmModal = document.getElementById('confirm-modal'); const confirmText = document.getElementById('confirm-text'); const confirmYesBtn = document.getElementById('confirm-yes-btn'); const confirmNoBtn = document.getElementById('confirm-no-btn'); const inputModal = document.getElementById('input-modal'); const inputText = document.getElementById('input-text'); const inputField = document.getElementById('input-field'); const inputOkBtn = document.getElementById('input-ok-btn'); const inputCancelBtn = document.getElementById('input-cancel-btn'); messageOkBtn.addEventListener('click', () => messageModal.classList.add('hidden')); return { showMessage: (message) => { messageText.textContent = message; messageModal.classList.remove('hidden'); }, showConfirm: (message) => new Promise(resolve => { confirmText.textContent = message; confirmModal.classList.remove('hidden'); const yesHandler = () => { resolve(true); confirmModal.classList.add('hidden'); confirmYesBtn.removeEventListener('click', yesHandler); confirmNoBtn.removeEventListener('click', noHandler); }; const noHandler = () => { resolve(false); confirmModal.classList.add('hidden'); confirmYesBtn.removeEventListener('click', yesHandler); confirmNoBtn.removeEventListener('click', noHandler); }; confirmYesBtn.addEventListener('click', yesHandler); confirmNoBtn.addEventListener('click', noHandler); }), showInput: (message, defaultValue = '') => new Promise(resolve => { inputText.textContent = message; inputField.value = defaultValue; inputModal.classList.remove('hidden'); inputField.focus(); const okHandler = () => { resolve(inputField.value); inputModal.classList.add('hidden'); inputOkBtn.removeEventListener('click', okHandler); inputCancelBtn.removeEventListener('click', cancelHandler); }; const cancelHandler = () => { resolve(null); inputModal.classList.add('hidden'); inputOkBtn.removeEventListener('click', okHandler); inputCancelBtn.removeEventListener('click', cancelHandler); }; inputOkBtn.addEventListener('click', okHandler); inputCancelBtn.addEventListener('click', cancelHandler); }) }; })();

            // --- GAME STATE ---
            let currentStoryId = null; let storyData = {}; let currentSceneId = 'start'; let currentItemIndex = 0; let isAdminMode = false; let sceneItems = []; let isInteractingWithHotspot = false;  let currentUser = null; let isInLobby = true; let isLobbyAdminMode = false;
            let isShowingSequentialText = false;

            // --- DEFAULT STORY ---
            const defaultStoryData = { start: { backgroundImage: 'https://placehold.co/800x600/2d3748/e2e8f0?text=새로운+이야기', script: `[장소: 시작의 방]\n[인물: 나레이션]\n새로운 이야기의 시작입니다.` } };
            
            // --- SCRIPT PARSER ---
            function parseScript(scriptText) { 
                const lines = (scriptText || '').split('\n'); const items = []; let currentCharacter = '나레이션'; let currentItem = null;
                for (let i=0; i < lines.length; i++) {
                    const line = lines[i];
                    const trimmedLine = line.trim();
                    const locationMatch = trimmedLine.match(/^\[장소:\s*(.*?)\]$/);
                    const eventMatch = trimmedLine.match(/^\[EVENT:\s*(.*?)\]$/);
                    const labelMatch = trimmedLine.match(/^\[LABEL:\s*(.*?)\]$/);
                    const charMatch = trimmedLine.match(/^\[인물:\s*(.*?)\]$/);
                    const choiceMatch = trimmedLine.match(/^>\s*(.*?)\s*\{(GOTO|SHOW):\s*(.*?)\s*\}$/);
                    const hotspotMatch = trimmedLine.match(/^@\s*(.*?)\s*\{X:\s*([\d.]+)\s*,\s*Y:\s*([\d.]+)\s*,\s*W:\s*([\d.]+)\s*,\s*H:\s*([\d.]+)\s*,\s*(GOTO|SHOW):\s*(.*?)\s*\}$/);
                    const gotoMatch = trimmedLine.match(/^\[GOTO:\s*(.*?)\]$/);

                    if (locationMatch) { items.push({ type: 'location', name: locationMatch[1] }); currentItem = null; }
                    else if (eventMatch) { items.push({ type: 'event', text: eventMatch[1] }); currentItem = null; }
                    else if (gotoMatch) { items.push({ type: 'goto', target: gotoMatch[1].trim() }); currentItem = null; }
                    else if (labelMatch) { items.push({ type: 'label', name: labelMatch[1] }); currentItem = null; }
                    else if (charMatch) { currentCharacter = charMatch[1]; currentItem = null; } 
                    else if (trimmedLine === '[선택지]') { currentItem = { type: 'choice', choices: [] }; items.push(currentItem); }
                    else if (trimmedLine === '[조사지점]') { currentItem = { type: 'hotspot', hotspots: [] }; items.push(currentItem); }
                    else if (choiceMatch && currentItem?.type === 'choice') { currentItem.choices.push({ text: choiceMatch[1], type: choiceMatch[2].toLowerCase(), target: choiceMatch[3] }); }
                    else if (hotspotMatch && currentItem?.type === 'hotspot') { currentItem.hotspots.push({ name: hotspotMatch[1], x: parseFloat(hotspotMatch[2]), y: parseFloat(hotspotMatch[3]), width: parseFloat(hotspotMatch[4]), height: parseFloat(hotspotMatch[5]), type: hotspotMatch[6].toLowerCase(), target: hotspotMatch[7], lineIndex: i }); }
                    else if (trimmedLine !== '') { items.push({ type: 'dialogue', character: currentCharacter, text: trimmedLine }); currentItem = null; }
                }
                return items;
            }

            // --- GAME LOGIC ---
            let typingTimeout;
            function showLocationPopup(locationName) { return new Promise(resolve => { locationPopupContent.textContent = `장소: ${locationName}`; locationPopup.classList.remove('hidden', 'opacity-0'); setTimeout(() => { locationPopup.classList.add('opacity-0'); setTimeout(() => { locationPopup.classList.add('hidden'); resolve(); }, 500); }, 1500); }); }
            
            function showEventPopup(text) {
                return new Promise(resolve => {
                    eventPopupContent.innerHTML = '';
                    const chars = text.split('');
                    
                    chars.forEach(char => {
                        const span = document.createElement('span');
                        span.className = 'event-char';
                        span.textContent = char === ' ' ? '\u00A0' : char;
                        eventPopupContent.appendChild(span);
                    });

                    eventPopup.classList.remove('hidden', 'opacity-0');

                    const spans = eventPopupContent.querySelectorAll('.event-char');
                    let totalDelay = 0;
                    spans.forEach((span, index) => {
                        const delay = index * 70;
                        setTimeout(() => {
                            span.classList.add('visible');
                        }, delay);
                        totalDelay = delay;
                    });
                    
                    setTimeout(() => {
                        eventPopup.classList.add('opacity-0');
                        setTimeout(() => {
                            eventPopup.classList.add('hidden');
                            resolve();
                        }, 500);
                    }, totalDelay + 1200);
                });
            }
            
            function typeWriterEffect(text, element, callback) { clearTimeout(typingTimeout); element.textContent = ''; let i = 0; function type() { if (i < text.length) { element.textContent += text.charAt(i); i++; typingTimeout = setTimeout(type, 30); } else if (callback) { callback(); } } type(); };
            
            // [!!] 신규: 순차적 텍스트 출력 함수
            function showSequentialText(textTarget, onComplete) {
                isShowingSequentialText = true;
                const textParts = textTarget.split('/').map(t => t.trim());
                let partIndex = 0;

                const cleanupAndComplete = () => {
                    gameContainer.removeEventListener('click', advanceText);
                    isShowingSequentialText = false;
                    if (onComplete) onComplete();
                };

                const advanceText = (e) => {
                    if (e.target.closest('.choice-btn') || e.target.closest('.hotspot') || e.target.closest('#admin-panel') || e.target.closest('#admin-panel-toggle') || e.target.closest('#exit-hotspot-btn') || e.target.closest('.control-btn')) {
                        return;
                    }
                    e.stopPropagation();

                    const fullText = textParts[partIndex - 1] || '';
                    if (dialogueText.textContent.length < fullText.length) {
                        clearTimeout(typingTimeout);
                        dialogueText.textContent = fullText;
                    } else {
                        if (partIndex >= textParts.length) {
                            cleanupAndComplete();
                        } else {
                            showNextPart();
                        }
                    }
                };
                
                function showNextPart() {
                    if (partIndex < textParts.length) {
                        const currentText = textParts[partIndex];
                        typeWriterEffect(currentText, dialogueText);
                        partIndex++;
                    }
                }

                dialogueContentBox.style.display = 'block';
                characterName.textContent = '';
                showNextPart();
                gameContainer.addEventListener('click', advanceText);
            }

            function renderDialogue(item) {
                exitHotspotBtn.classList.add('hidden');
                dialogueContentBox.style.display = 'block';
                characterName.textContent = item.character;
                typeWriterEffect(item.text, dialogueText);

                if (item.character === '나레이션') {
                    characterName.style.display = 'none';
                } else {
                    characterName.style.display = 'block';
                }
                dialogueContentBox.classList.remove('text-center');
                dialogueContentBox.classList.add('text-left');
            };
            
            function renderHotspots(item) { 
                (item.hotspots || []).forEach(hotspot => { 
                    const hpElement = document.createElement('div'); 
                    hpElement.className = 'hotspot'; 
                    hpElement.style.left = `${hotspot.x}%`; 
                    hpElement.style.top = `${hotspot.y}%`; 
                    hpElement.style.width = `${hotspot.width}%`; 

                    const labelContainer = document.createElement('div');
                    labelContainer.className = 'hotspot-label-container';
                    
                    const lineSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    lineSvg.setAttribute('class', 'hotspot-line');
                    lineSvg.setAttribute('viewBox', '0 0 80 50');
                    const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
                    polyline.setAttribute('points', '0,25 35,25 50,-5');
                    lineSvg.appendChild(polyline);

                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'hotspot-name';
                    nameSpan.textContent = hotspot.name;

                    labelContainer.appendChild(lineSvg);
                    labelContainer.appendChild(nameSpan);
                    hpElement.appendChild(labelContainer);
                    
                    hpElement.addEventListener('click', (e) => { 
                        e.stopPropagation(); 
                        if (hotspot.type === 'goto') { 
                            if (hotspot.target) renderScene(hotspot.target); 
                        } else if (hotspot.type === 'show') { 
                            exitHotspotBtn.classList.add('hidden');
                            gameContainer.querySelectorAll('.hotspot').forEach(hp => hp.remove()); 
                            showSequentialText(hotspot.target, () => {
                                processNextItem();
                            });
                        } 
                    }); 
                    gameContainer.appendChild(hpElement); 
                });
                exitHotspotBtn.classList.remove('hidden');
            };
            
            function renderChoices(item) {
                exitHotspotBtn.classList.add('hidden');
                choicesBox.innerHTML = '';
                (item.choices || []).forEach(choice => { 
                    const button = document.createElement('button'); 
                    button.textContent = choice.text; 
                    button.className = 'choice-btn w-full'; 
                    button.addEventListener('click', (e) => { 
                        e.stopPropagation(); 
                        if (choice.type === 'goto') { renderScene(choice.target); } 
                        else if (choice.type === 'show') { 
                            choicesBox.innerHTML = ''; 
                            showSequentialText(choice.target, () => {
                                currentItemIndex++;
                                processNextItem();
                            });
                        } 
                    }); 
                    choicesBox.appendChild(button); 
                });
            };
            
            async function processNextItem() {
                choicesBox.innerHTML = '';
                gameContainer.querySelectorAll('.hotspot').forEach(hp => hp.remove());
                exitHotspotBtn.classList.add('hidden');
                
                if (currentItemIndex >= sceneItems.length) {
                    dialogueContentBox.style.display = 'none';
                    return;
                }

                let item = sceneItems[currentItemIndex];

                while(item && (item.type === 'location' || item.type === 'label' || item.type === 'event' || item.type === 'goto')) {
                    if (item.type === 'event') {
                        await showEventPopup(item.text);
                    }
                    if (item.type === 'goto') {
                        await renderScene(item.target);
                        return;
                    }
                    currentItemIndex++;
                     if (currentItemIndex >= sceneItems.length) {
                        dialogueContentBox.style.display = 'none';
                        return;
                    }
                    item = sceneItems[currentItemIndex];
                }

                if (!item) {
                    dialogueContentBox.style.display = 'none';
                    return;
                }

                switch (item.type) {
                    case 'dialogue':
                        renderDialogue(item);
                        break;
                    case 'choice':
                        renderChoices(item);
                        break;
                    case 'hotspot':
                        dialogueContentBox.style.display = 'none';
                        renderHotspots(item);
                        break;
                }
            }
            async function renderScene(sceneTarget) {
                exitHotspotBtn.classList.add('hidden');

                const [sceneId, labelName] = sceneTarget.split('@');
                const scene = storyData[sceneId];

                if (!scene) {
                    showMessage(`장면 "${sceneId}"를 찾을 수 없습니다.`);
                    currentSceneId = 'start';
                    await renderScene('start');
                    return;
                }
                currentSceneId = sceneId;
                gameScreen.style.backgroundImage = `url(${scene.backgroundImage || ''})`;
                sceneItems = parseScript(scene.script || '');
                currentItemIndex = 0;

                if (labelName) {
                    const labelIndex = sceneItems.findIndex(item => item.type === 'label' && item.name === labelName);
                    if (labelIndex !== -1) {
                        currentItemIndex = labelIndex;
                    }
                }

                const locationItem = sceneItems.find(item => item.type === 'location');
                if (locationItem && !labelName) {
                    await showLocationPopup(locationItem.name);
                }
                await processNextItem();
            }

            function advanceFlow(e) {
                if (isShowingSequentialText) return;

                if (e && (e.target.closest('.choice-btn') || e.target.closest('.hotspot') || e.target.closest('#admin-panel') || e.target.closest('#admin-panel-toggle') || e.target.closest('#exit-hotspot-btn'))) {
                    return;
                }
                const currentItem = sceneItems[currentItemIndex];
                if (currentItem && currentItem.type === 'dialogue') {
                    const fullText = currentItem.text || '';
                    if (dialogueText.textContent.length < fullText.length) {
                        clearTimeout(typingTimeout);
                        dialogueText.textContent = fullText;
                    } else {
                        currentItemIndex++;
                        processNextItem();
                    }
                }
            }
            
            // --- LOBBY LOGIC ---
            function updateLobbyAdminUI() {
                if (isLobbyAdminMode) {
                    createNewStoryBtn.classList.remove('hidden');
                    document.querySelectorAll('.story-delete-btn').forEach(btn => btn.classList.remove('hidden'));
                } else {
                    createNewStoryBtn.classList.add('hidden');
                    document.querySelectorAll('.story-delete-btn').forEach(btn => btn.classList.add('hidden'));
                }
            }

            function showLobby() { 
                isInLobby = true;
                updateSaveSlotsUI();
                saveSlotsContainer.classList.remove('hidden');
                setTimeout(() => saveSlotsContainer.classList.remove('opacity-0'), 10);
                exitHotspotBtn.classList.add('hidden');
                lobbyScreen.classList.remove('hidden'); 
                appContainer.classList.add('hidden'); 
                backToLobbyBtn.classList.add('hidden'); 
                restartBtnContainer.classList.add('hidden');
                toggleAdminBtn.classList.add('hidden'); 
                adminPanelToggle.classList.add('hidden'); 
                if(isAdminMode) toggleAdminMode(); 
            }
            async function loadAndPlayStory(storyId, storyDoc, startingSceneId = 'start') { 
                isInLobby = false;
                updateSaveSlotsUI();
                exitHotspotBtn.classList.add('hidden');
                loadingSpinner.classList.remove('hidden'); 
                lobbyScreen.classList.add('hidden'); 
                appContainer.classList.remove('hidden'); 
                backToLobbyBtn.classList.remove('hidden'); 
                restartBtnContainer.classList.remove('hidden');
                currentStoryId = storyId; 
                const storyContent = storyDoc.data(); 
                storyTitleInput.value = storyContent.title; 
                storySubtitleInput.value = storyContent.subtitle || ''; 
                try { storyData = JSON.parse(storyContent.data); } catch { storyData = defaultStoryData; } 
                toggleAdminBtn.classList.remove('hidden'); 
                await renderScene(startingSceneId); 
                loadingSpinner.classList.add('hidden'); 
            }
            async function createNewStory() { const title = await showInput("새 스토리의 제목을 입력하세요.", "새로운 챕터"); if(!title) return; const subtitle = await showInput("스토리의 부제목을 입력하세요.", "이야기의 시작"); if(subtitle === null) return; loadingSpinner.classList.remove('hidden'); try { const newStoryRef = await addDoc(collection(db, "stories"), { title: title, subtitle: subtitle, creatorId: currentUser.uid, createdAt: new Date(), data: JSON.stringify(defaultStoryData) }); const newStoryDoc = await getDoc(newStoryRef); await loadAndPlayStory(newStoryDoc.id, newStoryDoc); } catch(e) { showMessage("스토리 생성에 실패했습니다."); } finally { loadingSpinner.classList.add('hidden'); } }
            async function deleteStory(storyId) { if (await showConfirm("정말로 이 스토리를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.")) { loadingSpinner.classList.remove('hidden'); try { await deleteDoc(doc(db, "stories", storyId)); showMessage("스토리가 삭제되었습니다."); } catch(e) { showMessage("스토리 삭제에 실패했습니다."); } finally { loadingSpinner.classList.add('hidden'); } } }

            // --- ADMIN LOGIC ---
            function toggleAdminPanel() {
                const isOpen = !adminPanel.classList.contains('-translate-x-full');
                if (isOpen) {
                    adminPanel.classList.add('-translate-x-full');
                    adminPanelToggle.style.transform = 'translateX(0%)';
                    adminToggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>';
                } else {
                    adminPanel.classList.remove('-translate-x-full');
                    const panelWidth = adminPanel.offsetWidth;
                    adminPanelToggle.style.transform = `translateX(${panelWidth}px)`;
                    adminToggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>';
                }
            }
            function toggleAdminMode() { 
                isAdminMode = !isAdminMode; 
                if(isAdminMode) { 
                    adminPanelToggle.classList.remove('hidden');
                    updateAdminPanel(); 
                    if (adminPanel.classList.contains('-translate-x-full')) {
                        toggleAdminPanel();
                    }
                } else { 
                    if (!adminPanel.classList.contains('-translate-x-full')) {
                        toggleAdminPanel();
                    }
                    adminPanelToggle.classList.add('hidden');
                    hotspotPreviewsContainer.innerHTML = ''; 
                } 
            }

            function updateAdminPanel() { if (!isAdminMode) return; sceneIdSelect.innerHTML = Object.keys(storyData).map(id => `<option value="${id}">${id}</option>`).join(''); sceneIdSelect.value = currentSceneId; const scene = storyData[currentSceneId]; if (!scene) return; bgImageInput.value = scene.backgroundImage || ''; sceneScriptEditor.value = scene.script || ''; hotspotPreviewsContainer.innerHTML = ''; parseScript(scene.script || '').forEach(item => { if (item.type === 'hotspot') { (item.hotspots || []).forEach(hotspot => renderHotspotPreview(hotspot)); } }); handleEditorCursorChange(); }
            function renderHotspotPreview(hotspot) { const preview = document.createElement('div'); preview.className = 'hotspot-preview'; preview.dataset.lineIndex = hotspot.lineIndex; preview.style.left = `${hotspot.x}%`; preview.style.top = `${hotspot.y}%`; preview.style.width = `${hotspot.width}%`; const handle = document.createElement('div'); handle.className = 'resize-handle br'; preview.appendChild(handle); preview.addEventListener('click', (e) => { e.stopPropagation(); const lineIdx = parseInt(e.currentTarget.dataset.lineIndex); if(isNaN(lineIdx)) return; const scriptText = sceneScriptEditor.value; const lines = scriptText.split('\n'); let charIndex = 0; for (let i = 0; i < lines.length; i++) { if (i === lineIdx) { sceneScriptEditor.focus(); sceneScriptEditor.selectionStart = charIndex; sceneScriptEditor.selectionEnd = charIndex + lines[i].length; handleEditorCursorChange(); break; } charIndex += lines[i].length + 1; } }); makeDraggableAndResizable(preview); hotspotPreviewsContainer.appendChild(preview); }
            function makeDraggableAndResizable(element) { let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0; let containerRect; const dragMouseDown = (e) => { if (e.target.closest('.resize-handle')) return; e.preventDefault(); pos3 = e.clientX; pos4 = e.clientY; isInteractingWithHotspot = true; containerRect = gameContainer.getBoundingClientRect(); document.onmouseup = closeDragElement; document.onmousemove = elementDrag; }; const elementDrag = (e) => { e.preventDefault(); pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY; let newTop = (element.offsetTop - pos2) / containerRect.height * 100; let newLeft = (element.offsetLeft - pos1) / containerRect.width * 100; const elWidth = parseFloat(element.style.width); newLeft = Math.max(0, Math.min(newLeft, 100 - elWidth)); newTop = Math.max(0, Math.min(newTop, 100 - elWidth * (containerRect.width/containerRect.height) )); element.style.top = `${newTop}%`; element.style.left = `${newLeft}%`; updateScriptFromPreview(element); }; const resizeMouseDown = (e) => { e.preventDefault(); e.stopPropagation(); pos3 = e.clientX; pos4 = e.clientY; isInteractingWithHotspot = true; containerRect = gameContainer.getBoundingClientRect(); document.onmouseup = closeDragElement; document.onmousemove = elementResize; }; const elementResize = (e) => { e.preventDefault(); const dx = e.clientX - pos3; let newWidth = (element.offsetWidth + dx) / containerRect.width * 100; pos3 = e.clientX; const elLeft = parseFloat(element.style.left); newWidth = Math.max(5, Math.min(newWidth, 100 - elLeft)); element.style.width = `${newWidth}%`; updateScriptFromPreview(element); }; const closeDragElement = () => { isInteractingWithHotspot = false; document.onmouseup = null; document.onmousemove = null; }; element.querySelector('.resize-handle.br').onmousedown = resizeMouseDown; element.onmousedown = dragMouseDown; }
               function updateScriptFromPreview(element) {
                const lineIndexToUpdate = parseInt(element.dataset.lineIndex);
                if (isNaN(lineIndexToUpdate)) return;

                const newX = parseFloat(element.style.left).toFixed(2);
                const newY = parseFloat(element.style.top).toFixed(2);
                const newW = parseFloat(element.style.width).toFixed(2);
                const containerRect = gameContainer.getBoundingClientRect();
                const newH = (newW * (containerRect.width / containerRect.height)).toFixed(2);

                const scriptLines = sceneScriptEditor.value.split('\n');
                const lineToUpdate = scriptLines[lineIndexToUpdate];
                
                if (!lineToUpdate) return;
                
                const parseRegex = /^@\s*(.*?)\s*\{X:\s*[\d.]+\s*,\s*Y:\s*[\d.]+\s*,\s*W:\s*[\d.]+\s*,\s*H:\s*[\d.]+\s*,\s*(GOTO|SHOW):\s*(.*?)\s*\}$/;
                const match = lineToUpdate.trim().match(parseRegex);

                if (match) {
                    const name = match[1];
                    const type = match[2];
                    const target = match[3];
                    
                    const newLine = `@ ${name} {X: ${newX}, Y: ${newY}, W: ${newW}, H: ${newH}, ${type.toUpperCase()}: ${target}}`;
                    
                    scriptLines[lineIndexToUpdate] = newLine;
                    const newScript = scriptLines.join('\n');
                    
                    if (sceneScriptEditor.value !== newScript) {
                        const cursorPosStart = sceneScriptEditor.selectionStart;
                        sceneScriptEditor.value = newScript;
                        sceneScriptEditor.setSelectionRange(cursorPosStart, cursorPosStart);
                        
                        sceneScriptEditor.dispatchEvent(new Event('input', { bubbles:true, cancelable:true }));
                    }
                }
            }
            function handleEditorCursorChange() { const cursorPos = sceneScriptEditor.selectionStart; const textUpToCursor = sceneScriptEditor.value.substring(0, cursorPos); const lineStart = textUpToCursor.lastIndexOf('\n') + 1; const lineEnd = sceneScriptEditor.value.indexOf('\n', lineStart); const currentLine = sceneScriptEditor.value.substring(lineStart, lineEnd === -1 ? undefined : lineEnd); const scriptLines = sceneScriptEditor.value.split('\n'); const currentLineIndex = textUpToCursor.split('\n').length - 1; const hotspotMatch = currentLine.match(/^@\s*(.*?)\s*\{/); document.querySelectorAll('.hotspot-preview').forEach(p => p.classList.remove('selected')); if (hotspotMatch) { const preview = document.querySelector(`.hotspot-preview[data-line-index="${currentLineIndex}"]`); if (preview) { preview.classList.add('selected'); } } }
            function insertAtCursor(textarea, textToInsert) { const start = textarea.selectionStart; const end = textarea.selectionEnd; const text = textarea.value; textarea.value = text.substring(0, start) + textToInsert + text.substring(end); textarea.selectionStart = textarea.selectionEnd = start + textToInsert.length; textarea.focus(); textarea.dispatchEvent(new Event('input', { bubbles:true, cancelable:true })); }

            function updateSaveSlotsUI() {
                for (let i = 1; i <= 3; i++) {
                    const slot = document.getElementById(`save-slot-${i}`);
                    const saveData = JSON.parse(localStorage.getItem(`adv-save-${i}`));
                    slot.innerHTML = ''; // Clear previous content
                    if (saveData) {
                        slot.classList.add('filled');
                        slot.classList.remove('empty');
                        
                        const titleEl = document.createElement('div');
                        titleEl.className = 'save-slot-title';
                        titleEl.textContent = saveData.title;

                        const timeEl = document.createElement('div');
                        timeEl.className = 'save-slot-time';
                        timeEl.textContent = saveData.timestamp;

                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-save-btn';
                        deleteBtn.innerHTML = '&times;';
                        deleteBtn.dataset.slot = i;
                        deleteBtn.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            if (await showConfirm(`슬롯 ${i}의 저장 데이터를 삭제하시겠습니까?`)) {
                                localStorage.removeItem(`adv-save-${i}`);
                                updateSaveSlotsUI();
                                showMessage(`슬롯 ${i} 삭제 완료.`);
                            }
                        });

                        slot.appendChild(titleEl);
                        slot.appendChild(timeEl);
                        slot.appendChild(deleteBtn);

                    } else {
                        slot.classList.add('empty');
                        slot.classList.remove('filled');
                        slot.textContent = `슬롯 ${i} (비어있음)`;
                    }
                }
            }

            async function handleSlotClick(slotNumber) {
                const saveData = JSON.parse(localStorage.getItem(`adv-save-${slotNumber}`));
                
                if (isInLobby) { // 로비: 불러오기
                    if (!saveData) {
                        showMessage("빈 슬롯입니다.");
                        return;
                    }
                    if(await showConfirm(`"${saveData.title}"을(를) 불러오시겠습니까?`)){
                         loadingSpinner.classList.remove('hidden');
                         try {
                            const storyDoc = await getDoc(doc(db, "stories", saveData.storyId));
                            if (storyDoc.exists()) {
                                await loadAndPlayStory(storyDoc.id, storyDoc, saveData.sceneId);
                            } else {
                                showMessage("스토리 데이터를 찾을 수 없습니다.");
                            }
                        } catch (e) {
                            showMessage("데이터를 불러오는 중 오류가 발생했습니다.");
                        } finally {
                            loadingSpinner.classList.add('hidden');
                        }
                    }
                } else { // 인게임: 저장
                    if (saveData && !(await showConfirm(`슬롯 ${slotNumber}에 덮어쓰시겠습니까?`))) {
                        return;
                    }
                    const newSaveData = {
                        storyId: currentStoryId,
                        sceneId: currentSceneId,
                        title: storyTitleInput.value || "제목 없음",
                        timestamp: new Date().toLocaleString('ko-KR')
                    };
                    localStorage.setItem(`adv-save-${slotNumber}`, JSON.stringify(newSaveData));
                    updateSaveSlotsUI();
                    showMessage(`게임이 슬롯 ${slotNumber}에 저장되었습니다.`);
                }
            }
            
            // --- EVENT LISTENERS ---
            (function setupListeners(){
                gameContainer.addEventListener('click', advanceFlow);
                
                toggleAdminBtn.addEventListener('click', async () => {
                    if (isAdminMode) {
                        toggleAdminMode();
                        showMessage("제작 도구가 비활성화되었습니다.");
                    } else {
                        const password = await showInput("관리자 비밀번호를 입력하세요.", "");
                        if (password === '0000') {
                            toggleAdminMode();
                            showMessage("제작 도구가 활성화되었습니다.");
                        } else if (password !== null) {
                            showMessage("비밀번호가 올바르지 않습니다.");
                        }
                    }
                });

                adminPanelToggle.addEventListener('click', toggleAdminPanel);
                
                lobbyAdminToggleBtn.addEventListener('click', async () => {
                    if (isLobbyAdminMode) {
                        isLobbyAdminMode = false;
                        showMessage("관리자 모드가 비활성화되었습니다.");
                    } else {
                        const password = await showInput("관리자 비밀번호를 입력하세요.", "");
                        if (password === '0000') {
                            isLobbyAdminMode = true;
                            showMessage("관리자 모드가 활성화되었습니다.");
                        } else if (password !== null) {
                            showMessage("비밀번호가 올바르지 않습니다.");
                        }
                    }
                    updateLobbyAdminUI();
                });

                exitHotspotBtn.addEventListener('click', () => {
                    currentItemIndex++;
                    processNextItem();
                });
                
                backToLobbyBtn.addEventListener('click', showLobby);
                
                restartGameBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    restartOptions.classList.toggle('hidden');
                    restartOptions.classList.toggle('flex');
                });

                document.addEventListener('click', (e) => {
                    if (!restartBtnContainer.contains(e.target)) {
                        restartOptions.classList.add('hidden');
                        restartOptions.classList.remove('flex');
                    }
                });
                
                restartSceneBtn.addEventListener('click', () => {
                    renderScene(currentSceneId);
                    restartOptions.classList.add('hidden');
                    restartOptions.classList.remove('flex');
                });
                restartStoryBtn.addEventListener('click', () => {
                    renderScene('start');
                    restartOptions.classList.add('hidden');
                    restartOptions.classList.remove('flex');
                });
                
                createNewStoryBtn.addEventListener('click', createNewStory);
                sceneIdSelect.addEventListener('change', () => { renderScene(sceneIdSelect.value); updateAdminPanel(); });
                addSceneBtn.addEventListener('click', async () => { const newSceneId = await showInput("새 장면의 ID를 입력하세요:", `scene_${Object.keys(storyData).length + 1}`); if (newSceneId && !storyData[newSceneId]) { storyData[newSceneId] = { backgroundImage: '', script: `[인물: 나레이션]\n새로운 장면입니다.` }; renderScene(newSceneId); updateAdminPanel(); } else if (newSceneId) { showMessage("이미 존재하는 장면 ID이거나 입력이 취소되었습니다."); } });
                deleteSceneBtn.addEventListener('click', async () => { if (Object.keys(storyData).length <= 1) { showMessage("마지막 남은 장면은 삭제할 수 없습니다."); return; } if (await showConfirm(`정말로 '${currentSceneId}' 장면을 삭제하시겠습니까?`)) { delete storyData[currentSceneId]; renderScene('start'); updateAdminPanel(); } });
                bgImageInput.addEventListener('input', () => { const scene = storyData[currentSceneId]; if (scene) scene.backgroundImage = bgImageInput.value; gameScreen.style.backgroundImage = `url(${bgImageInput.value})`; });
                sceneScriptEditor.addEventListener('input', () => { const scene = storyData[currentSceneId]; if(scene) scene.script = sceneScriptEditor.value; if (!isInteractingWithHotspot) { updateAdminPanel(); } });
                sceneScriptEditor.addEventListener('keyup', handleEditorCursorChange);
                sceneScriptEditor.addEventListener('click', handleEditorCursorChange);
                insertLocationBtn.addEventListener('click', () => insertAtCursor(sceneScriptEditor, '[장소: 장소 이름]\n'));
                insertEventBtn.addEventListener('click', () => insertAtCursor(sceneScriptEditor, '[EVENT: 이벤트 발생!]\n'));
                insertDialogueBtn.addEventListener('click', () => insertAtCursor(sceneScriptEditor, '\n[인물: 이름]\n대사를 입력하세요.\n'));
                insertLabelBtn.addEventListener('click', () => insertAtCursor(sceneScriptEditor, '\n[LABEL: 레이블_이름]\n'));
                insertChoiceBtn.addEventListener('click', () => insertAtCursor(sceneScriptEditor, '\n[선택지]\n> 선택지 1 {GOTO: 장면ID@레이블ID}\n> 선택지 2 {SHOW: 출력될 텍스트}\n'));
                insertHotspotBtn.addEventListener('click', () => insertAtCursor(sceneScriptEditor, '\n[조사지점]\n@ 이름 {X: 10, Y: 10, W: 20, H: 20, SHOW: 출력될 텍스트}\n'));
                insertGotoBtn.addEventListener('click', () => insertAtCursor(sceneScriptEditor, '\n[GOTO: 장면ID]\n'));

                for (let i = 1; i <= 3; i++) {
                    document.getElementById(`save-slot-${i}`).addEventListener('click', () => handleSlotClick(i));
                }

                syntaxHelpBtn.addEventListener('click', () => syntaxModal.classList.remove('hidden'));
                syntaxCloseBtn.addEventListener('click', () => syntaxModal.classList.add('hidden'));
                saveStoryBtn.addEventListener('click', async () => { if (!db || !currentStoryId) { showMessage("DB에 연결되지 않았거나 스토리가 선택되지 않았습니다."); return; } loadingSpinner.classList.remove('hidden'); try { await setDoc(doc(db, "stories", currentStoryId), { title: storyTitleInput.value, subtitle: storySubtitleInput.value, data: JSON.stringify(storyData) }, { merge: true }); showMessage("스토리가 성공적으로 저장되었습니다!"); } catch (error) { showMessage("스토리 저장 중 오류가 발생했습니다."); } finally { loadingSpinner.classList.add('hidden'); } });
            })();
            
            // --- FIREBASE & APP START ---
            let db;
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);
                await signInAnonymously(auth);
                currentUser = auth.currentUser;

                const q = query(collection(db, "stories"));
                onSnapshot(q, (querySnapshot) => {
                    storyList.innerHTML = '';
                    if (querySnapshot.empty) { storyList.innerHTML = `<p class="text-center text-gray-400">생성된 스토리가 없습니다. 새 스토리를 만들어보세요!</p>`; }
                    const docs = querySnapshot.docs;
                    docs.forEach((doc) => {
                        const story = doc.data();
                        const storyEl = document.createElement('div');
                        storyEl.className = "story-item";
                        
                        const mainContent = document.createElement('div');
                        mainContent.innerHTML = `<div class="story-item-title">${story.title || "제목 없음"}</div><div class="story-item-meta">${story.subtitle || "부제목 없음"}</div>`;
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
                        deleteBtn.className = "story-delete-btn text-red-400 hover:text-red-600 ml-4 flex-shrink-0 p-2";
                        deleteBtn.onclick = (e) => { e.stopPropagation(); deleteStory(doc.id); };
                        
                        storyEl.appendChild(mainContent);
                        storyEl.appendChild(deleteBtn);
                        storyEl.onclick = () => loadAndPlayStory(doc.id, doc);


                        storyList.appendChild(storyEl);
                    });
                    updateLobbyAdminUI();
                });
                loadingSpinner.classList.add('hidden');
                showLobby();
            } catch (error) {
                loadingSpinner.classList.add('hidden');
                showMessage("Firebase 초기화 실패: " + error.message);
            }
        };

        startApp();
    </script>
</body>
</html>

